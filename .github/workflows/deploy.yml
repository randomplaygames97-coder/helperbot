# ðŸš€ Deploy Automatico su Render
# Questo workflow si attiva ad ogni push su main branch

name: ðŸš€ Auto Deploy to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Controlli di qualitÃ  del codice
  quality-checks:
    name: ðŸ” Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ§ª Test Imports
      run: |
        python test_imports.py
        
    - name: âœ… Syntax Check
      run: |
        python -m py_compile app/main.py
        python -m py_compile app/bot.py
        python -m py_compile app/models.py
        
    - name: ðŸ“Š Code Quality Report
      run: |
        echo "âœ… All quality checks passed!"
        echo "ðŸ“ Files checked:"
        echo "  - app/main.py"
        echo "  - app/bot.py" 
        echo "  - app/models.py"
        echo "  - requirements.txt"

  # Job 2: Notifica deploy automatico
  deploy-notification:
    name: ðŸ“¢ Deploy Notification
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸš€ Deploy Trigger
      run: |
        echo "ðŸš€ DEPLOY AUTOMATICO ATTIVATO!"
        echo "ðŸ“Š Commit: ${{ github.sha }}"
        echo "ðŸ‘¤ Author: ${{ github.actor }}"
        echo "ðŸ’¬ Message: ${{ github.event.head_commit.message }}"
        echo ""
        echo "ðŸ”„ Render riceverÃ  automaticamente questo aggiornamento"
        echo "â±ï¸ Deploy stimato: 2-3 minuti"
        echo "ðŸŒ URL: https://erixcastbot.onrender.com"
        
    - name: ðŸ“ Create Deploy Summary
      run: |
        echo "## ðŸš€ Deploy Automatico Completato" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Dettagli Deploy:" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Processo Automatico:" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… Quality checks completati" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸš€ Deploy trigger inviato a Render" >> $GITHUB_STEP_SUMMARY
        echo "3. â±ï¸ Deploy in corso (2-3 minuti)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Links:" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ¤– Bot Live](https://erixcastbot.onrender.com)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“Š Health Check](https://erixcastbot.onrender.com/health)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“ˆ Status](https://erixcastbot.onrender.com/status)" >> $GITHUB_STEP_SUMMARY

  # Job 3: Verifica post-deploy (solo per push su main)
  post-deploy-check:
    name: ðŸ” Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: [quality-checks, deploy-notification]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: â³ Wait for Deploy
      run: |
        echo "â³ Aspettando completamento deploy..."
        echo "ðŸ”„ Render riceve automaticamente il trigger grazie ad autoDeploy: true"
        echo "ðŸ“Š Monitoraggio deploy in corso..."
        sleep 240  # Aspetta 4 minuti per il deploy completo
        
    - name: ðŸ¥ Health Check
      run: |
        echo "ðŸ¥ Verificando health del servizio..."
        
        # Retry logic per health check
        for i in {1..10}; do
          echo "ðŸ”„ Tentativo $i/10..."
          
          # Test multiple endpoints
          if curl -f -s -m 30 https://erixcastbot.onrender.com/health > /dev/null; then
            echo "âœ… Health check PASSED!"
            
            # Get detailed health info
            echo "ðŸ“Š Dettagli health:"
            curl -s -m 30 https://erixcastbot.onrender.com/health || echo "Health response received"
            
            # Test additional endpoints
            echo "ðŸ” Testing additional endpoints..."
            curl -f -s -m 30 https://erixcastbot.onrender.com/ping && echo "âœ… Ping OK" || echo "âš ï¸ Ping failed"
            curl -f -s -m 30 https://erixcastbot.onrender.com/status && echo "âœ… Status OK" || echo "âš ï¸ Status failed"
            break
          else
            echo "âš ï¸ Health check failed, retry in 45s..."
            sleep 45
          fi
          
          if [ $i -eq 10 ]; then
            echo "âŒ Health check FAILED after 10 attempts"
            echo "ðŸ” Trying to get error details..."
            curl -v https://erixcastbot.onrender.com/health || true
            echo "âš ï¸ Deploy might still be in progress, check Render dashboard"
            # Don't fail the workflow, just warn
            exit 0
          fi
        done
        
    - name: ðŸŽ¯ Ping Test
      run: |
        echo "ðŸŽ¯ Testing ping endpoint..."
        curl -f -s https://erixcastbot.onrender.com/ping || echo "âš ï¸ Ping test failed"
        
    - name: âœ… Deploy Success
      run: |
        echo "ðŸŽ‰ DEPLOY COMPLETATO CON SUCCESSO!"
        echo "âœ… Tutti i controlli post-deploy sono passati"
        echo "ðŸ¤– Bot operativo su: https://erixcastbot.onrender.com"
        echo ""
        echo "ðŸ“Š Deploy Summary:"
        echo "  - Commit: ${{ github.sha }}"
        echo "  - Branch: ${{ github.ref_name }}"
        echo "  - Author: ${{ github.actor }}"
        echo "  - Time: $(date -u)"
        echo "  - Status: âœ… SUCCESS"
        
    - name: ðŸ“Š Final Deploy Report
      run: |
        echo "## ðŸŽ‰ Deploy Automatico Completato con Successo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Stato Finale: SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Verifiche Completate:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Quality checks" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Syntax validation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Import tests" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Health check endpoint" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Service availability" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Servizio Attivo:" >> $GITHUB_STEP_SUMMARY
        echo "- **URL:** https://erixcastbot.onrender.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Health:** https://erixcastbot.onrender.com/health" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** https://erixcastbot.onrender.com/status" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # Job 4: Gestione fallimenti
  deploy-failure:
    name: âŒ Deploy Failure Handler
    runs-on: ubuntu-latest
    needs: [quality-checks, deploy-notification, post-deploy-check]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: âŒ Deploy Failed
      run: |
        echo "âŒ DEPLOY FALLITO!"
        echo "ðŸ” Analizzando il problema..."
        echo ""
        echo "ðŸ“Š Dettagli errore:"
        echo "  - Commit: ${{ github.sha }}"
        echo "  - Branch: ${{ github.ref_name }}"
        echo "  - Author: ${{ github.actor }}"
        echo "  - Workflow: ${{ github.workflow }}"
        echo ""
        echo "ðŸ› ï¸ Azioni consigliate:"
        echo "  1. Controlla i logs di Render"
        echo "  2. Verifica le variabili d'ambiente"
        echo "  3. Testa localmente il codice"
        echo "  4. Controlla la connessione database"
        
    - name: ðŸ“ Create Failure Report
      run: |
        echo "## âŒ Deploy Automatico Fallito" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš¨ Errore Rilevato:" >> $GITHUB_STEP_SUMMARY
        echo "Il deploy automatico su Render Ã¨ fallito durante l'esecuzione." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Dettagli:" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ› ï¸ Azioni Consigliate:" >> $GITHUB_STEP_SUMMARY
        echo "1. ðŸ“‹ Controlla i [logs di Render](https://dashboard.render.com)" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸ”§ Verifica le variabili d'ambiente" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸ§ª Testa il codice localmente" >> $GITHUB_STEP_SUMMARY
        echo "4. ðŸ” Controlla la connessione al database SQLite" >> $GITHUB_STEP_SUMMARY
        echo "5. ðŸ“ž Verifica i token Telegram e OpenAI" >> $GITHUB_STEP_SUMMARY